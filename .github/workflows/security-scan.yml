name: Security Scan

# Apple.comçº§åˆ«çš„è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æ
# æ¯æ¬¡pushå’Œå®šæœŸæ‰«æéƒ½ä¼šæ‰§è¡Œ

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  security-headers-check:
    name: Security Headers Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check Security Headers
      run: |
        echo "ğŸ” Checking security headers in index.html..."
        
        # æ£€æŸ¥å¿…éœ€çš„å®‰å…¨å¤´éƒ¨
        required_headers=(
          "Content-Security-Policy"
          "X-Frame-Options"
          "X-Content-Type-Options"
          "X-XSS-Protection"
          "Referrer-Policy"
          "Permissions-Policy"
        )
        
        for header in "${required_headers[@]}"; do
          if grep -q "$header" index.html; then
            echo "âœ… Found: $header"
          else
            echo "âŒ Missing: $header"
            exit 1
          fi
        done
        
        echo "âœ… All security headers present!"

  csp-validation:
    name: Content Security Policy Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Validate CSP
      run: |
        echo "ğŸ” Validating Content Security Policy..."
        
        # æ£€æŸ¥CSPæ˜¯å¦å­˜åœ¨å±é™©æŒ‡ä»¤
        if grep -q "unsafe-eval" index.html; then
          echo "âŒ DANGER: unsafe-eval found in CSP!"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰CSP
        if grep -q "Content-Security-Policy" index.html; then
          echo "âœ… CSP found"
          
          # æ£€æŸ¥å…³é”®æŒ‡ä»¤
          if grep -q "default-src 'self'" index.html; then
            echo "âœ… default-src 'self' configured"
          fi
          
          if grep -q "frame-ancestors 'none'" index.html; then
            echo "âœ… frame-ancestors 'none' configured"
          fi
          
          if grep -q "upgrade-insecure-requests" index.html; then
            echo "âœ… upgrade-insecure-requests enabled"
          fi
        else
          echo "âŒ No CSP found!"
          exit 1
        fi

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check for external dependencies
      run: |
        echo "ğŸ” Checking for external dependencies..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å¤–éƒ¨è„šæœ¬å¼•ç”¨
        if grep -E '<script[^>]+src="http' index.html; then
          echo "âš ï¸ External script found - check if necessary"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å¤–éƒ¨æ ·å¼å¼•ç”¨
        if grep -E '<link[^>]+href="http' index.html; then
          echo "âš ï¸ External stylesheet found - check if necessary"
        fi
        
        echo "âœ… Dependency check complete"

  secrets-scan:
    name: Secrets Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: TruffleHog Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
    
    - name: Check for common secrets patterns
      run: |
        echo "ğŸ” Scanning for secrets..."
        
        # æ£€æŸ¥å¸¸è§çš„å¯†é’¥æ¨¡å¼
        patterns=(
          "api[_-]?key"
          "password"
          "secret"
          "token"
          "private[_-]?key"
        )
        
        for pattern in "${patterns[@]}"; do
          if grep -ri "$pattern" --exclude-dir=.git --exclude="*.md" .; then
            echo "âš ï¸ Found potential secret: $pattern"
          fi
        done

  html-validation:
    name: HTML Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: HTML5 Validator
      uses: Cyb3r-Jak3/html5validator-action@v7.1.1
      with:
        root: ./
    
    - name: Check HTML structure
      run: |
        echo "ğŸ” Validating HTML structure..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰DOCTYPE
        if ! grep -q "<!DOCTYPE html>" index.html; then
          echo "âŒ Missing DOCTYPE"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰langå±æ€§
        if ! grep -q '<html lang=' index.html; then
          echo "âŒ Missing lang attribute"
          exit 1
        fi
        
        echo "âœ… HTML structure valid"

  link-check:
    name: Check Broken Links
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Link Checker
      uses: lycheeverse/lychee-action@v1.8.0
      with:
        args: --verbose --no-progress './**/*.html' './**/*.md'
        fail: true

  security-scorecard:
    name: Security Scorecard
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      id-token: write
    
    steps:
    - name: "Checkout code"
      uses: actions/checkout@v3
      with:
        persist-credentials: false
    
    - name: "Run analysis"
      uses: ossf/scorecard-action@v2.3.1
      with:
        results_file: results.sarif
        results_format: sarif
        publish_results: true

  notify-security-team:
    name: Notify Security Team
    runs-on: ubuntu-latest
    needs: [security-headers-check, csp-validation, secrets-scan]
    if: failure()
    
    steps:
    - name: Send notification
      run: |
        echo "ğŸš¨ Security scan failed!"
        echo "Please review the security scan results immediately."
        # åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™é‡Œå¯ä»¥å‘é€é‚®ä»¶æˆ–Slacké€šçŸ¥

